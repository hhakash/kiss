<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Kisses üíã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --pastel-pink: #ffd1dc;
            --pastel-purple: #e0bbe4;
            --pastel-blue: #b2cefe;
            --pixel-border: 4px;
        }

        body {
            font-family: 'VT323', monospace;
            background-color: var(--pastel-pink);
            background-image: 
                linear-gradient(45deg, #ffffff 25%, transparent 25%), 
                linear-gradient(-45deg, #ffffff 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ffffff 75%), 
                linear-gradient(-45deg, transparent 75%, #ffffff 75%);
            background-size: 40px 40px;
            background-position: 0 0, 0 20px, 20px 20px, 20px 0;
            background-color: #fff5f7;
            overflow-x: hidden;
        }

        .pixel-card {
            background: white;
            border: var(--pixel-border) solid #333;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
            image-rendering: pixelated;
        }

        .pixel-btn {
            background: #ff85a2;
            border: var(--pixel-border) solid #333;
            box-shadow: 4px 4px 0px #333;
            transition: all 0.1s;
            cursor: pointer;
        }

        .pixel-btn:active {
            box-shadow: 0px 0px 0px #333;
            transform: translate(4px, 4px);
        }

        .kiss-animation {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            font-size: 2rem;
            animation: flyUp 2s forwards ease-out;
        }

        @keyframes flyUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-200px) scale(2); opacity: 0; }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .status-pill {
            border: 2px solid #333;
            padding: 2px 10px;
            display: inline-block;
            background: var(--pastel-blue);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="max-w-md w-full">
        <!-- Loading State -->
        <div id="loading" class="pixel-card p-8 text-center">
            <h1 class="text-4xl mb-4">Loading Love...</h1>
            <div class="text-2xl animate-pulse">üíãüíãüíã</div>
        </div>

        <!-- Auth/User Selection (Internal Use) -->
        <div id="setup-view" class="hidden pixel-card p-8 text-center">
            <h1 class="text-4xl mb-6">Who are you?</h1>
            <button onclick="switchUser('hha')" class="pixel-btn w-full py-3 mb-4 text-2xl text-white">I am HHA</button>
            <button onclick="switchUser('ppita')" class="pixel-btn w-full py-3 text-2xl text-white bg-purple-400">I am Ppita</button>
        </div>

        <!-- Main Interaction View -->
        <div id="main-view" class="hidden">
            <div class="pixel-card p-6 text-center bg-white">
                <div class="flex justify-between items-center mb-6">
                    <span id="user-tag" class="status-pill text-xl font-bold uppercase"></span>
                    <span id="connection-status" class="status-pill text-xl bg-green-200">Online</span>
                </div>

                <div class="mb-8 floating">
                    <div id="pixel-heart" class="text-8xl mb-4">‚ù§Ô∏è</div>
                    <h2 id="greeting" class="text-3xl font-bold">Waiting for a kiss...</h2>
                </div>

                <div id="interaction-area">
                    <button id="send-kiss-btn" class="pixel-btn w-full py-4 text-3xl text-white mb-4">
                        SEND KISS! üíã
                    </button>
                    <p class="text-lg opacity-60">Click to send a vibration & notification</p>
                </div>

                <div id="history-box" class="mt-8 border-t-2 border-dashed border-gray-300 pt-4">
                    <h3 class="text-xl mb-2">Love History</h3>
                    <div id="messages" class="text-lg space-y-1 h-32 overflow-y-auto">
                        <!-- History logs go here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, limit, updateDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kiss-day-app';

        let currentUser = null;
        let partnerId = '';
        let userId = '';

        // 1. Logic to detect user from URL
        const urlParams = new URLSearchParams(window.location.search);
        const userParam = urlParams.get('user'); // ?user=hha or ?user=ppita

        async function init() {
            // Register Service Worker for Notifications
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log(err));
            }

            // Auth
            await signInAnonymously(auth);
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    if (userParam === 'hha' || userParam === 'ppita') {
                        setupApp(userParam);
                    } else {
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('setup-view').classList.remove('hidden');
                    }
                }
            });
        }

        window.switchUser = (u) => {
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + `?user=${u}`;
            window.history.pushState({path:newUrl},'',newUrl);
            setupApp(u);
        };

        function setupApp(selectedUser) {
            userId = selectedUser;
            partnerId = (userId === 'hha') ? 'ppita' : 'hha';
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('user-tag').innerText = userId;
            
            requestNotificationPermission();
            listenForKisses();
        }

        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        // 2. Sending a Kiss
        document.getElementById('send-kiss-btn').onclick = async () => {
            const kissRef = collection(db, 'artifacts', appId, 'public', 'data', 'kisses');
            const kissData = {
                from: userId,
                to: partnerId,
                timestamp: serverTimestamp(),
                type: 'initial'
            };

            spawnKissEffect();
            
            try {
                await addDoc(kissRef, kissData);
                addLog(`You sent a kiss to ${partnerId}!`);
            } catch (e) {
                console.error("Error sending kiss", e);
            }
        };

        // 3. Listening for Kisses
        function listenForKisses() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'kisses');
            
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        // Prevent reacting to old data or our own messages
                        const time = data.timestamp?.toMillis() || Date.now();
                        if (Date.now() - time > 10000) return; 

                        if (data.to === userId) {
                            handleIncomingKiss(data);
                        }
                    }
                });
            }, (error) => console.error(error));
        }

        function handleIncomingKiss(data) {
            // 4. Vibrate phone
            if ("vibrate" in navigator) {
                navigator.vibrate([200, 100, 200]);
            }

            // 5. Update UI
            document.getElementById('greeting').innerText = `${data.from} sent you a kiss!`;
            document.getElementById('pixel-heart').innerText = "üòò";
            addLog(`${data.from} kissed you!`);

            // 6. Push Notification (if tab is hidden)
            if (document.visibilityState !== 'visible') {
                showLocalNotification(data.from);
            }

            // Reset UI after 5 seconds
            setTimeout(() => {
                document.getElementById('greeting').innerText = "Send one back?";
                document.getElementById('pixel-heart').innerText = "‚ù§Ô∏è";
            }, 5000);
        }

        function showLocalNotification(sender) {
            if (Notification.permission === "granted") {
                new Notification("New Kiss! üíã", {
                    body: `${sender} sent you a kissy! Click to return it.`,
                    icon: "https://img.icons8.com/pixel-styled/96/filled-like.png"
                });
            }
        }

        function spawnKissEffect() {
            const kiss = document.createElement('div');
            kiss.className = 'kiss-animation';
            kiss.innerText = 'üíã';
            kiss.style.left = Math.random() * 80 + 10 + '%';
            kiss.style.bottom = '20%';
            document.body.appendChild(kiss);
            setTimeout(() => kiss.remove(), 2000);
        }

        function addLog(msg) {
            const box = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = "border-b border-pink-100 py-1";
            div.innerText = `> ${msg}`;
            box.prepend(div);
        }

        init();
    </script>

    <script>
        // Inline Service Worker Simulation for GitHub Pages Environment
        // In a real production environment, this would be a separate sw.js file
        const swContent = `
            self.addEventListener('push', (event) => {
                const data = event.data.json();
                self.registration.showNotification(data.title, {
                    body: data.body,
                    icon: 'https://img.icons8.com/pixel-styled/96/filled-like.png'
                });
            });
        `;
    </script>
</body>
</html>
