<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kiss Me üíã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root { --pastel-pink: #ffd1dc; --pixel-border: 4px; }
        body {
            font-family: 'VT323', monospace;
            background-color: #ffe6ea;
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z' fill='%23ffb7c5' fill-opacity='0.4'/%3E%3C/svg%3E");
            background-size: 32px 32px;
            overflow: hidden; position: fixed; width: 100%; height: 100%;
        }
        .pixel-card { background: white; border: var(--pixel-border) solid #333; box-shadow: 6px 6px 0px rgba(0,0,0,0.15); width: 100%; }
        .pixel-btn { background: #ff85a2; border: var(--pixel-border) solid #333; box-shadow: 4px 4px 0px #333; transition: all 0.1s; cursor: pointer; text-transform: uppercase; touch-action: manipulation; color: white; }
        .pixel-btn:active { box-shadow: 0px 0px 0px #333; transform: translate(4px, 4px); }
        .kiss-animation { position: fixed; pointer-events: none; z-index: 100; font-size: 3.5rem; animation: flyUp 1.5s forwards ease-out; }
        @keyframes flyUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-350px) scale(2.5) rotate(20deg); opacity: 0; } }
        .status-pill { border: 2px solid #333; padding: 2px 12px; background: #b2cefe; font-size: 1.25rem; }
    </style>
</head>
<body>
    <audio id="kiss-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div id="app-container" class="h-screen flex items-center justify-center p-4">
        <div id="app" class="max-w-md w-full">
            <div id="config-view" class="pixel-card p-6 text-center">
                <h1 class="text-4xl mb-4">Setup Kiss Me</h1>
                <input type="password" id="api-key-input" placeholder="Enter Ably API Key" class="w-full border-2 border-black p-3 mb-6 text-center outline-none">
                <button onclick="saveConfig()" class="pixel-btn w-full py-4 text-2xl">Connect Heart üîì</button>
            </div>

            <div id="setup-view" class="hidden pixel-card p-6 text-center">
                <h1 class="text-4xl mb-6">Who are you?</h1>
                <button onclick="setRole('hha')" class="pixel-btn w-full py-4 mb-4 text-2xl">I am HHA</button>
                <button onclick="setRole('ppita')" class="pixel-btn w-full py-4 text-2xl bg-purple-400">I am Ppita</button>
            </div>

            <div id="main-view" class="hidden">
                <div class="pixel-card p-5 text-center bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <span id="user-tag" class="status-pill font-bold"></span>
                        <span id="connection-status" class="status-pill bg-yellow-200">Wait...</span>
                    </div>
                    <div class="mb-6">
                        <div id="pixel-heart" class="text-8xl mb-2">‚ù§Ô∏è</div>
                        <h2 id="greeting" class="text-3xl font-bold">Ready?</h2>
                    </div>
                    <button id="send-kiss-btn" class="pixel-btn w-full py-5 text-3xl">SEND KISS</button>
                    <div id="messages" class="mt-4 h-32 overflow-y-auto text-left font-sans text-sm border-t border-dashed pt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ably, channel, userId, partnerId;

        window.onload = () => {
            const savedKey = localStorage.getItem('ably_kiss_key');
            const savedRole = localStorage.getItem('kiss_app_role');
            if (savedKey) {
                document.getElementById('config-view').classList.add('hidden');
                if (savedRole) initApp(savedRole);
                else document.getElementById('setup-view').classList.remove('hidden');
            }
        };

        function saveConfig() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) { localStorage.setItem('ably_kiss_key', key); location.reload(); }
        }

        function setRole(role) {
            localStorage.setItem('kiss_app_role', role);
            initApp(role);
        }

        function initApp(role) {
            userId = role;
            partnerId = (userId === 'hha') ? 'ppita' : 'hha';
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('user-tag').innerText = userId.toUpperCase();

            ably = new Ably.Realtime(localStorage.getItem('ably_kiss_key'));
            channel = ably.channels.get('kiss-channel');

            ably.connection.on('connected', () => {
                document.getElementById('connection-status').innerText = "Online";
                document.getElementById('connection-status').className = "status-pill bg-green-200";
            });

            channel.subscribe('kiss', (m) => {
                if (m.data.to === userId) handleIncomingKiss(m.data);
            });
        }

        document.getElementById('send-kiss-btn').onclick = () => {
            const data = { from: userId, to: partnerId, ts: Date.now() };
            channel.publish('kiss', data);
            spawnKissEffect();
            addLog("Sent a kiss! üíã");
        };

        function handleIncomingKiss(data) {
            const audio = document.getElementById('kiss-sound');
            audio.play().catch(() => {});
            document.getElementById('pixel-heart').innerText = "üòò";
            setTimeout(() => { document.getElementById('pixel-heart').innerText = "‚ù§Ô∏è"; }, 2000);
            addLog(`${data.from} kissed you!`);
            
            // This line tells the Android App to show a system notification
            if(window.Android) { window.Android.showNotification(`Kiss from ${data.from}`, "Tap to kiss back! üíã"); }
        }

        function spawnKissEffect() {
            const kiss = document.createElement('div');
            kiss.className = 'kiss-animation';
            kiss.innerText = 'üíã';
            kiss.style.left = Math.random() * 60 + 20 + '%';
            kiss.style.top = '40%';
            document.body.appendChild(kiss);
            setTimeout(() => kiss.remove(), 1500);
        }

        function addLog(msg) {
            const box = document.getElementById('messages');
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            box.prepend(div);
        }
    </script>
</body>
</html>
