<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Kisses üíã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --pastel-pink: #ffd1dc;
            --pastel-purple: #e0bbe4;
            --pastel-blue: #b2cefe;
            --pixel-border: 4px;
        }

        body {
            font-family: 'VT323', monospace;
            background-color: #fff5f7;
            background-image: 
                linear-gradient(45deg, #ffffff 25%, transparent 25%), 
                linear-gradient(-45deg, #ffffff 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ffffff 75%), 
                linear-gradient(-45deg, transparent 75%, #ffffff 75%);
            background-size: 40px 40px;
            background-position: 0 0, 0 20px, 20px 20px, 20px 0;
            overflow-x: hidden;
        }

        .pixel-card {
            background: white;
            border: var(--pixel-border) solid #333;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
            image-rendering: pixelated;
        }

        .pixel-btn {
            background: #ff85a2;
            border: var(--pixel-border) solid #333;
            box-shadow: 4px 4px 0px #333;
            transition: all 0.1s;
            cursor: pointer;
        }

        .pixel-btn:active {
            box-shadow: 0px 0px 0px #333;
            transform: translate(4px, 4px);
        }

        .kiss-animation {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            font-size: 3rem;
            animation: flyUp 2s forwards ease-out;
        }

        @keyframes flyUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-300px) scale(2) rotate(20deg); opacity: 0; }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .status-pill {
            border: 2px solid #333;
            padding: 2px 10px;
            display: inline-block;
            background: var(--pastel-blue);
        }

        #messages::-webkit-scrollbar { width: 4px; }
        #messages::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="max-w-md w-full">
        <!-- Configuration View (Hidden after key is saved) -->
        <div id="config-view" class="pixel-card p-8 text-center">
            <h1 class="text-4xl mb-4">Setup Love Link</h1>
            <p class="mb-4">Enter your Ably API Key to start</p>
            <input type="password" id="api-key-input" placeholder="Paste Ably Key Here" class="w-full border-2 border-black p-2 mb-4 text-center font-sans">
            <button onclick="saveConfig()" class="pixel-btn w-full py-2 text-xl text-white">Save & Start</button>
            <p class="text-xs mt-4 opacity-50 italic">Key is stored only on your device.</p>
        </div>

        <!-- Selection View -->
        <div id="setup-view" class="hidden pixel-card p-8 text-center">
            <h1 class="text-4xl mb-6">Who are you?</h1>
            <button onclick="initApp('hha')" class="pixel-btn w-full py-3 mb-4 text-2xl text-white">I am HHA</button>
            <button onclick="initApp('ppita')" class="pixel-btn w-full py-3 text-2xl text-white bg-purple-400">I am Ppita</button>
        </div>

        <!-- Main Interaction View -->
        <div id="main-view" class="hidden">
            <div class="pixel-card p-6 text-center bg-white">
                <div class="flex justify-between items-center mb-6">
                    <span id="user-tag" class="status-pill text-xl font-bold uppercase"></span>
                    <span id="connection-status" class="status-pill text-xl bg-yellow-200">Connecting...</span>
                </div>

                <div class="mb-8 floating">
                    <div id="pixel-heart" class="text-8xl mb-4">‚ù§Ô∏è</div>
                    <h2 id="greeting" class="text-3xl font-bold">Waiting for love...</h2>
                </div>

                <div id="interaction-area">
                    <button id="send-kiss-btn" class="pixel-btn w-full py-4 text-3xl text-white mb-4">
                        SEND KISS! üíã
                    </button>
                </div>

                <div id="history-box" class="mt-8 border-t-2 border-dashed border-gray-300 pt-4">
                    <h3 class="text-xl mb-2">Love Log</h3>
                    <div id="messages" class="text-lg space-y-1 h-32 overflow-y-auto text-left px-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ably, channel, userId, partnerId;

        // Check if API key exists in localStorage
        window.onload = () => {
            const savedKey = localStorage.getItem('ably_kiss_key');
            if (savedKey) {
                document.getElementById('config-view').classList.add('hidden');
                checkUrlParams();
            }
        };

        function saveConfig() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                localStorage.setItem('ably_kiss_key', key);
                location.reload();
            }
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const user = params.get('user');
            if (user === 'hha' || user === 'ppita') {
                initApp(user);
            } else {
                document.getElementById('setup-view').classList.remove('hidden');
            }
        }

        function initApp(role) {
            userId = role;
            partnerId = (userId === 'hha') ? 'ppita' : 'hha';

            // UI Transitions
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            document.getElementById('user-tag').innerText = userId;

            // Initialize Ably
            const key = localStorage.getItem('ably_kiss_key');
            ably = new Ably.Realtime(key);
            channel = ably.channels.get('kiss-day-channel');

            ably.connection.on('connected', () => {
                document.getElementById('connection-status').innerText = "Online";
                document.getElementById('connection-status').classList.replace('bg-yellow-200', 'bg-green-200');
            });

            // Listen for Kisses
            channel.subscribe('kiss', (message) => {
                if (message.data.to === userId) {
                    handleIncomingKiss(message.data);
                }
            });

            // Request Notification Permission
            if ("Notification" in window) Notification.requestPermission();
        }

        document.getElementById('send-kiss-btn').onclick = () => {
            if (!channel) return;

            const data = { from: userId, to: partnerId, time: Date.now() };
            channel.publish('kiss', data);
            
            spawnKissEffect();
            addLog(`Sent a kiss to ${partnerId}!`);
        };

        function handleIncomingKiss(data) {
            // Vibrate
            if ("vibrate" in navigator) {
                navigator.vibrate([300, 100, 300, 100, 500]);
            }

            // UI Feedback
            document.getElementById('pixel-heart').innerText = "üòò";
            document.getElementById('greeting').innerText = `${data.from} kissed you!`;
            addLog(`${data.from} sent a kissy! üíñ`);

            // Notifications
            if (document.visibilityState !== 'visible') {
                new Notification("üíã Kiss Day!", {
                    body: `${data.from} just sent you a kiss! Tap to return it.`,
                    icon: "https://img.icons8.com/pixel-styled/96/filled-like.png"
                });
            }

            setTimeout(() => {
                document.getElementById('pixel-heart').innerText = "‚ù§Ô∏è";
                document.getElementById('greeting').innerText = "Send one back? ‚ú®";
            }, 5000);
        }

        function spawnKissEffect() {
            const kiss = document.createElement('div');
            kiss.className = 'kiss-animation';
            kiss.innerText = 'üíã';
            kiss.style.left = Math.random() * 80 + 10 + '%';
            kiss.style.bottom = '20%';
            document.body.appendChild(kiss);
            setTimeout(() => kiss.remove(), 2000);
        }

        function addLog(msg) {
            const box = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = "border-b border-pink-100 py-1 text-sm";
            div.innerText = `[${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}] > ${msg}`;
            box.prepend(div);
        }
    </script>
</body>
</html>
